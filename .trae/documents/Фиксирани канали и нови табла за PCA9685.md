## Какво ще се промени

* Каналите стават **твърдо фиксирани в кода** (без опции за пренасочване от настройките), за да няма риск за хардуера.

* Ще се публикуват **нови Home Assistant entities чрез MQTT Discovery**, с имена/типове според таблата, които описа.

* Логовете ще се ограничат до: **грешки + еднократни стартови съобщения** (без „шум“ при всяка MQTT команда).

## Фиксиран mapping (PCA9685 channels)

* **PWM 1**: CH0 – PWM ON/OFF + slider (запазваме текущата концепция за ON/OFF и визуализация).

* **Heaters**: CH1 Heater 1, CH2 Heater 2, CH3 Heater 3, CH4 Heater 4 – ON/OFF.

* **Fans**: CH5 Fan 1, CH6 Fan 2 – ON/OFF.

* **Control Step Motor** (един мотор):

  * CH7 DIR – CW/CCW (ръчно), показва посоката.

  * CH8 ENA – ON/OFF (ръчно), включва/изключва стъпковия.

* **PWM 2**:

  * CH9 PU – генератор на импулси с **динамична честота** и **фиксиран duty 50%**.

* **System**:

  * CH15 – системен LED: мига през 1 сек (без entity на дашборда).

## Отговор на въпроса за CH9 (динамична честота)

* PCA9685 има **една обща PWM честота за всички канали** (глобална), т.е. не може „истинска“ независима честота само за CH9 без да влияе на другите.

* Можем да реализираме CH9 като **software pulse генератор**: включване/изключване на канала през `time.sleep(period/2)` за 50% duty.

* Ограничения: честотата ще е практична за **ниски/средни Hz** (I2C + Linux scheduling → jitter). Ако ти трябва kHz стабилно (за step pulses), ще предложа алтернатива (GPIO/друг таймер).

## Home Assistant entities (как ще се виждат)

* **PWM 1 (CH0)**: `switch` (Enable) + `number` (0–100%).

* **Heaters (CH1–CH4)**: 4× `switch`.

* **Fans (CH5–CH6)**: 2× `switch`.

* **Step Motor**:

  * DIR (CH7): `select` с опции `CW`/`CCW` (по-ясно от switch и показва текущата посока).

  * ENA (CH8): `switch`.

* **PWM 2 (CH9)**:

  * Enable: `switch`.

  * Frequency: `number` (Hz) – промяната ще действа „на живо“. Този порт трябава да генерира честота от 0 до 1 кНz – с коефициент на запълване 50%.

* **CH15**: стартира в отделна нишка на boot, без Discovery.

## Промени по файловете

* [config.yaml](file:///h:/My%20Drive/RABOTNA/PYTHON/TATKO/PCA9685_PWM_controll/config.yaml)

  * Ще премахна/скрия опциите за избор на канали (`motor_channel`, `led*_channel`, `relay_channel`), за да не могат да се сменят от UI.

  * Ще оставя само нещата, които са безопасни да се настройват: MQTT и I2C адрес/обща PCA честота (ако е нужно за CH0 PWM).

  * (По желание) ще добавя параметри за CH9: min/max за честота, стартова честота.

* [run.py](file:///h:/My%20Drive/RABOTNA/PYTHON/TATKO/PCA9685_PWM_controll/run.py)

  * Ще refactor-на текущата логика (която е за motor+2 LEDs+relay) към новия фиксиран mapping и новите topics.

  * Ще добавя 2 работни нишки:

    * CH15 системен blink (1s).

    * CH9 pulse generator (enable + freq, duty 50%).

  * Ще сменя `print()` към `logging` и ще оставя само стартови INFO и ERROR при проблеми; ще махна логването на всяко MQTT съобщение.

  * `safe_shutdown()` ще спира нишките и ще изключва всички изходи безопасно.

## Верификация

* Ще добавя кратка self-check логика при старт (без spam): проверка, че каналите са в диапазон 0–15 и че няма конфликт в дефинициите.

* Ще валидирам, че Discovery payload-ите се публикуват за всички entities и че кодът стартира без syntax/runtime грешки.

Ако потвърдиш плана, започвам с реалните промени по файловете.
